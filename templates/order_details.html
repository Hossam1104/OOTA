{% extends "base.html" %}

{% block content %}
<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="section-title">Order Details</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" id="calculateTotals">
                <i class="bi bi-calculator"></i> Calculate Totals
            </button>
            <a href="{{ url_for('export_json') }}" class="btn btn-success" target="_blank">
                <i class="bi bi-download"></i> Export JSON
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-number" id="productsTotal">0.00</div>
            <div class="quick-stat-label">Products Total</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="orderDiscount">0.00</div>
            <div class="quick-stat-label">Order Discount</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="deliveryCost">0.00</div>
            <div class="quick-stat-label">Delivery Cost</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number text-primary" id="finalTotal">0.00</div>
            <div class="quick-stat-label">Final Total</div>
        </div>
    </div>

    <div class="grid-container">
        <!-- Order Information Card -->
        <div class="grid-item">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Order Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_order') }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Branch Code</label>
                                <input type="text" class="form-control" name="branch_code" value="{{ data.branch_code }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Order Code</label>
                                <input type="text" class="form-control" name="order_code" value="{{ data.order_code }}">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Delivery Cost</label>
                                <input type="number" step="0.01" class="form-control" name="delivery_cost" value="{{ data.order_delivery_cost }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Is Delivery</label>
                                <select class="form-select" name="is_delivery">
                                    <option value="1" {% if data.is_delivery== 1 %}selected{% endif %}>Yes</option>
                                    <option value="0" {% if data.is_delivery== 0 %}selected{% endif %}>No</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Order Status</label>
                                <select class="form-select" name="order_status">
                                    <option value="new" {% if data.order_status==
                                    'new' %}selected{% endif %}>New</option>
                                    <option value="cancelled" {% if data.order_status==
                                    'cancelled' %}selected{% endif %}>Cancelled</option>
                                    <option value="confirmed" {% if data.order_status==
                                    'confirmed' %}selected{% endif %}>Confirmed</option>
                                    <option value="done" {% if data.order_status==
                                    'done' %}selected{% endif %}>Done</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Delivery Date</label>
                                <input type="date" class="form-control" name="delivery_date" value="{{ data.delivery_date }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fulfillment Plant</label>
                                <input type="text" class="form-control" name="fulfillment_plant" value="{{ data.fullfilment_plant }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Shipping Address 2</label>
                                <input type="text" class="form-control" name="shipping_address_2" value="{{ data.shipping_address_2 }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Order Notes</label>
                                <textarea class="form-control" name="order_notes" rows="2">{{ data.order_notes }}</textarea>
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-check-circle me-2"></i>Update Order
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Client Information Card -->
        <div class="grid-item">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person me-2"></i>Client Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_order') }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="first_name" value="{{ data.client_first_name }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="last_name" value="{{ data.client_last_name }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Middle Name</label>
                                <input type="text" class="form-control" name="middle_name" value="{{ data.client_middle_name }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" name="phone" value="{{ data.client_phone }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" value="{{ data.client_email }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Birthdate</label>
                                <input type="date" class="form-control" name="birthdate"
                                       value="{{ data.client_birthdate[:10] if data.client_birthdate }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Gender</label>
                                <select class="form-select" name="gender">
                                    <option value="Male" {% if data.client_gender==
                                    'Male' %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if data.client_gender==
                                    'Female' %}selected{% endif %}>Female</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Country Code</label>
                                <input type="text" class="form-control" name="country_code" value="{{ data.client_country_code }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" name="address" value="{{ data.order_address }}">
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-check-circle me-2"></i>Update Client
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delivery Information Card -->
        <div class="grid-item">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-truck me-2"></i>Delivery Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_order') }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">From Time (HH:MM:SS)</label>
                                <input type="text" class="form-control" name="delivery_from_time" value="{{ data.delivery_from_time }}"
                                       placeholder="12:23:10.323">
                                <small class="text-muted">Format: HH:MM:SS or HH:MM:SS.mmm</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">To Time (HH:MM:SS)</label>
                                <input type="text" class="form-control" name="delivery_to_time" value="{{ data.delivery_to_time }}"
                                       placeholder="03:23:10">
                                <small class="text-muted">Format: HH:MM:SS or HH:MM:SS.mmm</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Payment Status</label>
                                <select class="form-select" name="order_payment_status">
                                    {% for status in payment_statuses %}
                                    <option value="{{ status }}" {% if data.order_payment_status== status %}selected{% endif %}>{{ status|replace('_',
                                        ' ')|title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-check-circle me-2"></i>Update Delivery
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cart me-2"></i>Products ({{ products|length }})</h5>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="bi bi-plus"></i> Add Product
            </button>
        </div>
        <div class="card-body">
            {% if products %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Discount</th>
                        <th>VAT %</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ product.item_name }}</div>
                            <small class="text-muted">{{ product.item_code }}</small>
                            {% if product.offer_code %}
                            <div class="text-info small mt-1">
                                <i class="bi bi-tag"></i> {{ product.offer_code }}
                                {% if product.offer_message %} - {{ product.offer_message }}{% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td>{{ product.quantity }}</td>
                        <td>${{ product.unit_price }}</td>
                        <td>${{ product.row_total_discount }}</td>
                        <td>{{ (product.vat_percentage * 100)|round(2) }}%</td>
                        <td class="fw-bold">${{ "%.2f"|format(product.row_net_total) }}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary edit-product" data-index="{{ loop.index0 }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <a href="{{ url_for('remove_product', index=loop.index0) }}" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-cart-x display-4"></i>
                <p class="mt-3">No products added yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_product') }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Item Code</label>
                            <input type="text" class="form-control" name="item_code" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-control" name="item_name" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quantity</label>
                            <input type="number" step="0.01" class="form-control" name="quantity" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Unit Price</label>
                            <input type="number" step="0.01" class="form-control" name="unit_price" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">VAT %</label>
                            <input type="number" step="0.01" class="form-control" name="vat_percentage" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Discount</label>
                            <input type="number" step="0.01" class="form-control" name="discount" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Offer Code</label>
                            <input type="text" class="form-control" name="offer_code">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Offer Message</label>
                            <input type="text" class="form-control" name="offer_message">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estimated Total</label>
                            <input type="text" class="form-control" id="estimatedTotal" readonly value="$0.00">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editProductForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Item Code</label>
                            <input type="text" class="form-control" name="item_code" id="editItemCode" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-control" name="item_name" id="editItemName" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quantity</label>
                            <input type="number" step="0.01" class="form-control" name="quantity" id="editQuantity" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Unit Price</label>
                            <input type="number" step="0.01" class="form-control" name="unit_price" id="editUnitPrice" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">VAT %</label>
                            <input type="number" step="0.01" class="form-control" name="vat_percentage" id="editVatPercentage" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Discount</label>
                            <input type="number" step="0.01" class="form-control" name="discount" id="editDiscount" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Offer Code</label>
                            <input type="text" class="form-control" name="offer_code" id="editOfferCode">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Offer Message</label>
                            <input type="text" class="form-control" name="offer_message" id="editOfferMessage">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estimated Total</label>
                            <input type="text" class="form-control" id="editEstimatedTotal" readonly value="$0.00">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .quick-stat {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
    }

    .quick-stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2c3e50;
    }

    .quick-stat-label {
        color: #7f8c8d;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
    }

    .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .grid-item {
        min-width: 0;
    }

    .section-title {
        color: #2c3e50;
        font-weight: 700;
        border-bottom: 3px solid #3498db;
        padding-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Calculate totals on page load
        calculateTotals();

        // Calculate totals button click
        $('#calculateTotals').click(function() {
            calculateTotals();
        });

        // Calculate estimated total in modals
        $('input[name="quantity"], input[name="unit_price"], input[name="vat_percentage"], input[name="discount"]').on('input', function() {
            calculateEstimatedTotal();
        });

        // Edit product functionality
        $('.edit-product').click(function() {
            const index = $(this).data('index');

            $.get('{{ url_for("update_product", index=0) }}'.replace('0', index), function(data) {
                if (!data.error) {
                    $('#editItemCode').val(data.item_code);
                    $('#editItemName').val(data.item_name);
                    $('#editQuantity').val(data.quantity);
                    $('#editUnitPrice').val(data.unit_price);
                    $('#editVatPercentage').val(data.vat_percentage);
                    $('#editDiscount').val(data.row_total_discount);
                    $('#editOfferCode').val(data.offer_code);
                    $('#editOfferMessage').val(data.offer_message);

                    // Update form action
                    $('#editProductForm').attr('action', '{{ url_for("update_product", index=0) }}'.replace('0', index));

                    // Show modal
                    $('#editProductModal').modal('show');

                    // Calculate estimated total
                    calculateEditEstimatedTotal();
                } else {
                    alert('Error loading product: ' + data.error);
                }
            }).fail(function() {
                alert('Error loading product details');
            });
        });

        // Calculate estimated total for edit modal
        $('#editQuantity, #editUnitPrice, #editVatPercentage, #editDiscount').on('input', function() {
            calculateEditEstimatedTotal();
        });

        function calculateTotals() {
            $.get('{{ url_for("calculate_totals") }}', function(data) {
                if (!data.error) {
                    $('#productsTotal').text(data.products_total.toFixed(2));
                    $('#orderDiscount').text(data.order_discount.toFixed(2));
                    $('#deliveryCost').text(data.delivery_cost.toFixed(2));
                    $('#finalTotal').text(data.final_total.toFixed(2));
                } else {
                    alert('Error calculating totals: ' + data.error);
                }
            });
        }

        function calculateEstimatedTotal() {
    const quantity = parseFloat($('input[name="quantity"]').val()) || 0;
    const unitPrice = parseFloat($('input[name="unit_price"]').val()) || 0;

    // Handle VAT input (could be 15 or 0.15)
    let vatInput = parseFloat($('input[name="vat_percentage"]').val()) || 0;
    let vatPercent = vatInput > 1 ? vatInput / 100 : vatInput;

    const discount = parseFloat($('input[name="discount"]').val()) || 0;

    const vatAmount = (quantity * unitPrice - discount) * vatPercent;
    const total = (quantity * unitPrice - discount) + vatAmount;

    $('#estimatedTotal').val('$' + total.toFixed(2));
}

function calculateEditEstimatedTotal() {
    const quantity = parseFloat($('#editQuantity').val()) || 0;
    const unitPrice = parseFloat($('#editUnitPrice').val()) || 0;

    // Handle VAT input (could be 15 or 0.15)
    let vatInput = parseFloat($('#editVatPercentage').val()) || 0;
    let vatPercent = vatInput > 1 ? vatInput / 100 : vatInput;

    const discount = parseFloat($('#editDiscount').val()) || 0;

    const vatAmount = (quantity * unitPrice - discount) * vatPercent;
    const total = (quantity * unitPrice - discount) + vatAmount;

    $('#editEstimatedTotal').val('$' + total.toFixed(2));
}
    });
</script>
{% endblock %}